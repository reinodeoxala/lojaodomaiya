<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Od√≤m√°√¨y√† Artigos Religiosos</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{font-family:Arial,Helvetica,sans-serif;background:#f6f8fb;margin:0}
header{background:#0b2c4a;color:#fff;padding:20px;text-align:center}
.produtos{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:16px;padding:20px}
.card{background:#fff;border-radius:12px;padding:15px;box-shadow:0 6px 16px rgba(0,0,0,.1)}
.card h3{margin:0 0 8px}
.card span{color:#0b2c4a;font-weight:bold}
.controls{display:flex;gap:8px;margin-top:10px}
.controls input{width:50px}
button{border:none;border-radius:20px;padding:8px 14px;cursor:pointer}
.add{background:#0b2c4a;color:#fff}
.cart{position:fixed;bottom:20px;left:20px;background:#0b2c4a;color:#fff;padding:12px 18px;border-radius:30px}
.admin-panel{display:none;padding:20px;background:#fff;margin:20px;border-radius:12px}
.admin-logado .admin-panel{display:block}
table{width:100%;border-collapse:collapse}
td,th{padding:8px;border-bottom:1px solid #ddd}
input[type=number]{width:80px}
</style>
</head>

<body>

<header>
<h1>Od√≤m√°√¨y√† Artigos Religiosos</h1>
<p>üìç Rua Sete de Agosto, 28 ‚Äì Passo Fundo/RS</p>
<p>üïí Seg‚ÄìSex: 10h‚Äì12h | 13:30‚Äì19h ‚Ä¢ S√°b: 10h‚Äì12h | 13:30‚Äì17h</p>
</header>

<div class="produtos" id="listaProdutos"></div>

<div class="cart" id="cartInfo">üõí Carrinho: 0 itens</div>

<!-- PAINEL ADMIN -->
<div class="admin-panel">
<h2>Painel Administrativo</h2>
<input id="busca" placeholder="Buscar produto">
<table>
<thead>
<tr><th>Produto</th><th>Pre√ßo</th><th>Estoque</th><th>Salvar</th></tr>
</thead>
<tbody id="adminTabela"></tbody>
</table>
</div>

<!-- FIREBASE -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import {
  getFirestore, collection, doc, getDoc, getDocs,
  runTransaction, updateDoc, setDoc, onSnapshot
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "SUA_API_KEY",
  authDomain: "SEU_DOMINIO",
  projectId: "SEU_PROJECT_ID",
};

const app = initializeApp(firebaseConfig);
const auth = getAuth();
const db = getFirestore();

/* ================= ADMIN ================= */
onAuthStateChanged(auth, async (user) => {
  if (!user) return;
  const phone = user.phoneNumber.replace("+","");
  const adminSnap = await getDoc(doc(db,"admins",phone));
  if (adminSnap.exists()) document.body.classList.add("admin-logado");
});

/* ================= PRODUTOS ================= */
const lista = document.getElementById("listaProdutos");
const cartInfo = document.getElementById("cartInfo");
let carrinho = {};

onSnapshot(collection(db,"produtos"), snap => {
  lista.innerHTML = "";
  snap.forEach(docu => {
    const p = docu.data();
    lista.innerHTML += `
      <div class="card">
        <h3>${p.nome}</h3>
        <span>R$ ${p.preco.toFixed(2)}</span><br>
        Estoque: ${p.estoque}
        <div class="controls">
          <input type="number" min="1" value="1" id="q_${docu.id}">
          <button class="add" onclick="addCarrinho('${docu.id}')">Adicionar</button>
        </div>
      </div>
    `;
  });
});

/* ================= CARRINHO + BLOQUEIO ================= */
window.addCarrinho = async (id) => {
  const qtd = Number(document.getElementById("q_"+id).value);

  await runTransaction(db, async (tx) => {
    const ref = doc(db,"produtos",id);
    const snap = await tx.get(ref);
    if (!snap.exists()) throw "Produto inexistente";
    if (snap.data().estoque < qtd) throw "Sem estoque";

    tx.update(ref,{estoque: snap.data().estoque - qtd});
  });

  carrinho[id] = (carrinho[id] || 0) + qtd;
  atualizarCarrinho();
};

function atualizarCarrinho(){
  let total = Object.values(carrinho).reduce((a,b)=>a+b,0);
  cartInfo.innerText = `üõí Carrinho: ${total} itens`;
}

/* ================= ADMIN ================= */
const adminTabela = document.getElementById("adminTabela");

onSnapshot(collection(db,"produtos"), snap => {
  adminTabela.innerHTML="";
  snap.forEach(d=>{
    const p=d.data();
    adminTabela.innerHTML+=`
      <tr>
        <td>${p.nome}</td>
        <td><input type="number" id="preco_${d.id}" value="${p.preco}"></td>
        <td><input type="number" id="estoque_${d.id}" value="${p.estoque}"></td>
        <td><button onclick="salvar('${d.id}')">Salvar</button></td>
      </tr>
    `;
  });
});

window.salvar = async (id)=>{
  await updateDoc(doc(db,"produtos",id),{
    preco:Number(document.getElementById("preco_"+id).value),
    estoque:Number(document.getElementById("estoque_"+id).value)
  });
};
</script>

</body>
</html>
